# Native API

LinuxJoystick has a native API that can be used to interface with devices that can not be accessed from the Java managed code environment. This API uses [Java Native Interface](http://docs.oracle.com/javase/7/docs/technotes/guides/jni/) and the interface with the native code is located in the `NoJoy` class. A native library has been written using this interface to access and use Xbox controllers in Windows by using the [XInput API](https://msdn.microsoft.com/en-us/library/windows/desktop/hh405053(v=vs.85).aspx).

## The NoJoy Class

`NoJoy` is an extension of the `LinuxJoystick` class that overrides the data access functions to use native functions instead of reading from a file. The following is the list of functions in the class:

```java
// Constructor
public NoJoy(int index)

// Public Java functions
public int[] getEnumeration()
public String getLinkErrorString() // contains stack trace if linking failed

// Native functions, accessed by public wrapper functions if private
public native String getVersionString()
private native int[] enumerate()
private native byte[] nativePoll()
private native boolean openNativeDevice(int index)
private native boolean isNativeDeviceOpen(int index)
private native void closeNativeDevice(int index)

// Set native property, very non-portable as it is native library-specific
public native byte[] setNativeProperty(int index, int key, int value)
```

A native library implementing this interface will have to implement all the specified native functions. `NoJoy` overrides `channelOpen()`, `channelRead()`, and `channelClose()` of `LinuxJoystick` to use these functions to access and read controller devices. The native `enumerate()` function is wrapped by the public Java `getEnumeration()` function.

The native functions should be self-explanatory. The following is a collection of contracts that must be fulfilled by the native library implementing the native functions to ensure proper execution of the program:
- `enumerate()` must return an array of integer with each element describing the enumerated device as described in the [linuxjoy-api](linuxjoy-api.md) document
- The framework will use the array indexing that the native library returned with `enumerate()` to identify which device is being used. Make sure the numbering is internally consistent in the native library
- `nativePoll()` must return serialized [Linux Joystick API](https://www.kernel.org/doc/Documentation/input/joystick-api.txt) packets (4-byte timestamp, 2-byte value, 1-byte type, and 1-byte number)
- `nativePoll()` may return up to 8KB worth of data
- `nativePoll()` must **not** block because there is not a safe way to interrupt a JNI call
- `nativePoll()` may return an empty array if there is no data. The function may **not** return a null pointer
- `nativePoll()` may return torn 8-byte data as long as it can complete it in subsequent polls (or the device is closed beforehand)
- `openNativeDevice(int index)` and `isNativeDeviceOpen(int index)` must return the correct device status
- `setNativeProperty` is not part of the official API and will not be used by support classes like `JoyFactory` in the LinuxJoystick library. Users wanting to use this function with a particular native library will have to implement it in the user program

`setNativeProperty` is a utility / debug function that can be called from the JVM to set some values in the native library, and / or to retrieve some non-joystick event data from the native library. This is a non-portable function that is not used internally in the LinuxJoystick library. The native library can return a null pointer and leave the rest of the function empty to satisfy the API if the functionality is not desired.

A C/C++ header file to be included by the native library source can be generated by using javah:

```
javah -cp LinuxJoystick.jar org.bbi.linux.NoJoy
```

The native library must be compiled as shared library `njnative.dll` in Windows or `libnjnative.so` in *nixes and be placed in the runtime classpath so LinuxJoystick can find and link with it.

## Windows XInput Native Library

A Windows [XInput](https://msdn.microsoft.com/en-us/library/windows/desktop/hh405053(v=vs.85).aspx) native library that implements the native API is included in LinuxJoystick. The source code of the native library is named [`winxinput.cpp`](LinuxJoystick/native/winxinput.cpp). This library can be compiled in Visual Studio 2015 with the provided solution file in `LinuxJoystick/native/njnative` and will generate `njnative.dll`.

**Note:** The architecture of the native library must match with the JVM architecture. E.g. a 32-bit native library will not be able to link with LinuxJoystick running on a 64-bit JVM, and vice versa. `NoJoy` keeps a stack trace if a link failure has occured. This stack trace can be accessed with the `NoJoy.getLinkErrorString()` function.

The native library will read the device status with XInput's `XInputGetState` function when its `nativePoll(int index)` function is called. It will then construct and return Linux Joystick API packets if there is a change in the state of the specified controller. The LinuxJoystick framework will decode these packets, update the joystick object state, and generate callback events.

### Miscellaneous

The NoJoy Windows XInput library has a few properties that can be useful:

- Key=0 - set dead zone value (0 to 32767) for the specified controller in the index value
- Key=1 - set vibration setting for the specified controller. High 16-bit of value field is LEFT motor, and the lower 16-bit controls the RIGHT motor
- Key=2 - return version array (4 bytes)
 
`getVersionString()` will return "NoJoy Windows XInput (njnative.dll) v1.00" with possible different version number.
